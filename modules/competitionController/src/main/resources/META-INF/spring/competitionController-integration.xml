<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2002-2010 the original author or authors.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<beans:beans xmlns="http://www.springframework.org/schema/integration"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd">

    <!--Generate a TimeslotUpdateCommand every 5 seconds-->
    <publish-subscribe-channel id="CcTimeslotUpdateCommandChannel"/>
    <inbound-channel-adapter ref="competitionController" method="processTimeslotUpdate"
                             channel="CcTimeslotUpdateCommandChannel">
        <poller fixed-rate="5000"/>
    </inbound-channel-adapter>

    <!--1. Publish TimeslotUpdateCommand to all brokers-->
    <!--TODO: Use marshalling to publish the TimeslotUpdateCommand to all brokers-->

    <!--2. Tariff Handling-->
    <!--Ask the accounting service for the current tariff list-->
    <publish-subscribe-channel id="AsTariffPublishedCommandChannel"/>
    <service-activator ref="accountingService" method="publishTariffList" input-channel="CcTimeslotUpdateCommandChannel"
                       output-channel="AsTariffPublishedCommandChannel"/>

    <!--2.1. Allow customers to decide if they want to subscribe or negotiate-->
    <channel id="CuTariffReplyCommandsChannel"/>
    <service-activator ref="customer" method="processTariffList"
                       input-channel="AsTariffPublishedCommandChannel" output-channel="CuTariffReplyCommandsChannel"/>

    <!--2.1.1. Validate every reply using the TariffRuleEnforcer-->
    <!--In order to do so, the message list in CuTariffReplyCommandsChannel is split into single messages first-->
    <channel id="CuTariffReplyCommandChannel"/>
    <splitter input-channel="CuTariffReplyCommandsChannel" output-channel="CuTariffReplyCommandChannel"/>

    <!--2.1.2. Use a filter to validate each reply-->
    <channel id="CuTariffReplyCommandAcceptedChannel"/>
    <channel id="CuTariffReplyCommandRejectedChannel"/>
    <filter input-channel="CuTariffReplyCommandChannel" output-channel="CuTariffReplyCommandAcceptedChannel"
            discard-channel="CuTariffReplyCommandRejectedChannel" ref="tariffRuleEnforcerProxy"/>

    <!--2.1.2.1. Process validated TariffReplyCommand objects and send them to their respective broker-->
    <channel id="CuBrTariffReplyCommandChannel"/>
    <service-activator ref="accountingService" method="processTariffReply"
                       input-channel="CuTariffReplyCommandAcceptedChannel"
                       output-channel="CuBrTariffReplyCommandChannel"/>
    <!--2.1.2.1.1-->
    <!--TODO: Publish TariffReplyCommands to brokers using marshalling-->

    <!--2.1.2.2-->
    <!--TODO: Process rejected TariffReplyCommand objects from the discarded-channel (notify sender (customer))-->

    <!--2.2 Publish list of TariffPublishedCommands to all brokers -->
    <!--TODO: Publish TariffPublishedCommands to all brokers through marshalling-->

    <!--3. Process deactivated timeslot-->
    <channel id="CcFilteredTimeslotUpdateCommandChannel"/>
    <filter input-channel="CcTimeslotUpdateCommandChannel" output-channel="CcFilteredTimeslotUpdateCommandChannel"
            expression="payload.enabled"/>


</beans:beans>
